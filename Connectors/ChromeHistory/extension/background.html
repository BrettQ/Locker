<script src="http://code.jquery.com/jquery-1.4.2.min.js"> </script>
<script>
var debug = false;
var startTime = 0;
//var url = '__INSERT_ME_DOT_URI_HERE__/urls';
var url = 'http://localhost:18043/urls';
function postHistory() {
    chrome.history.search({'text':'', 'maxResults':1000000, 'startTime':startTime}, function(urls) {
//        alert('urls: ' + urls.length);
        getVisits(urls, function(visitItems) {
  //          alert('visits: ' + visitItems.length);
            $.post(url, {urls:JSON.stringify(visitItems)},function(data) {
                if(debug) alert('posted data!');
                setTimeout(postHistory, 60000);
            }, 'UTF-8');    
        });
    });
}
function getLatest(callback) {
    $.get(url + endpoint + '/latest',callback);
}

function getVisits(historyItems, visitItems, callback) {
    if(!callback) {
        if(!visitItems)
            return;
        callback = visitItems;
        visitItems = [];
    }
    var url = historyItems.pop().url;
    if(historyItems.length > 0) {
        chrome.history.getVisits({'url':url}, function(visits) {
            for(var j in visits)
                visitItems.push(visits[j]);
            getVisits(historyItems, visitItems, callback);
        });
    } else {
        callback(visitItems);
    }
}

postHistory();

</script>